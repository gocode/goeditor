<link rel="import" href="/static/bower_components/polymer/polymer.html">
<link rel="import" href="/static/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/static/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/static/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/static/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/static/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/static/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/static/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="/static/bower_components/paper-input/paper-input.html">
<link rel="import" href="/static/bower_components/paper-button/paper-button.html">
<link rel="import" href="/static/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/static/bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="/static/bower_components/paper-radio-button/paper-radio-button.html">

<link rel="import" href="/static/tree-view.html">

<script src="/static/bower_components/ace-builds/src-min-noconflict/ace.js"></script>
<script src="/static/bower_components/ace-builds/src-min-noconflict/ext-language_tools.js"></script>
<script src="/static/bower_components/ace-builds/src-min-noconflict/ext-statusbar.js"></script>

<script src="/static/ajax.js"></script>

<dom-module id="go-editor">

	<style is="custom-style">
		#content {
			transition-duration: 400ms;
			transition-timing-function: ease-out;
		}

		#editor {
			font-size: 14px;
			height: 97%;
		}

		paper-button {
			background: #3f51b5;
			color: #fff;
		}

		#fileNameInput{
			width: 600px;
		}

		paper-toast {
			margin-left: 50px;
		}

		#settingsDialog {
			width: 500px;
		}
	}
	</style>

	<template>
		<div id="container" fullbleed layout vertical>
			<paper-drawer-panel force-narrow id="drawer" on-iron-select="resizeEditor">

				<paper-header-panel id="drawer" drawer>
					<paper-toolbar>
						<paper-icon-button icon="refresh" on-click="refreshSidebar"></paper-icon-button>
						<paper-icon-button icon="expand-more" on-click="expandSidebar"></paper-icon-button>
						<paper-icon-button icon="expand-less" on-click="collapseSidebar"></paper-icon-button>
					</paper-toolbar>
    				<div class="fit">
    					<tree-view id="sidebar" data="[[directory]]"></tree-view>
    				</div>
				</paper-header-panel>

				<paper-header-panel main>
					<paper-toolbar>
						<paper-icon-button icon="menu" on-click="toggleDrawer"></paper-icon-button>
						<paper-icon-button icon="add" on-click="createNewFile"></paper-icon-button>
						<paper-icon-button icon="refresh" on-click="refreshCodePage"></paper-icon-button>
						<paper-icon-button icon="save" on-click="save"></paper-icon-button>
						<paper-icon-button icon="settings" on-click="openSettingsDialog"></paper-icon-button>
						<span/></span>
						<div class="title">Go Editor</div>
					</paper-toolbar>

					<div id="content" class="fit">
						<div id="editor"></div>
						<div id="statusbar">[[autocompleteEntry]]</div>
					</div>

					<paper-dialog id="fileNameInput">
						<div>
							<paper-input label="Enter file name:" autofocus value="{{fileName}}"></paper-input></br>
						</div>
						<div class="buttons">
							<paper-button dialog-confirm on-click="setFileName">OK</paper-button>
						</div>
					</paper-dialog>

					<paper-dialog id="settingsDialog">
						<h2>Settings</h2>
						<paper-dialog-scrollable>
							<div>Language:</div>
							<paper-radio-group selected="{{language}}">
								<paper-radio-button checked name="golang">Go</paper-radio-button>
								<paper-radio-button name="html">HTML</paper-radio-button>
								<paper-radio-button name="javascript">JavaScript</paper-radio-button>
								<paper-radio-button name="css">CSS</paper-radio-button>
							</paper-radio-group>
							<paper-input label="GOPATH:" autofocus value="{{gopath}}"></paper-input>
							<paper-input label="Project Path:" value="{{projectPath}}"></paper-input>
							<paper-input label="Path to gocode binary:" value="{{gocodePath}}"></paper-input>
						</paper-dialog-scrollable>
						<br/>
						<div class="buttons">
							<paper-button dialog-dismiss>Cancel</paper-button>
							<paper-button dialog-confirm autofocus on-click="saveSettings">OK</paper-button>
						</div>
					</paper-dialog>	

					<paper-toast id="fileSavedToast" text="File Saved Successfully"></paper-toast>
				</paper-header-panel>

			</paper-drawer-panel>
		</div>
	</template>

	<script>
		var editor;

		function initEditor(that) {
			//setup editor
			var langTools = ace.require('ace/ext/language_tools');
			editor = ace.edit(that.$.editor);
			editor.setTheme('ace/theme/chrome');
			editor.getSession().setMode('ace/mode/golang');
			editor.getSession().setTabSize(4);

			// enable autocompletion
			editor.setOptions({
				enableBasicAutocompletion: true,
				enableSnippets: false,
				enableLiveAutocompletion: false
			});
			
			var gocodeCompleter = {
				getCompletions: function(editor, session, pos, prefix, callback) {
					var offset = editor.getSession().getDocument().positionToIndex(pos,  0) + 1;

					ajax({
						method: 'POST',
						url: '/autocomplete',
						data: {
							offset: offset,
							content: editor.getValue()
						},
						success: function(response) {
							callback(null, JSON.parse(response).Candidates);
						},
						error: function() {
							alert('error in autocomplete');
						}
					});
				}
			}

			editor.completers = [gocodeCompleter]

			var StatusBar = ace.require('ace/ext/statusbar').StatusBar;
			var statusBar = new StatusBar(editor, that.$.statusbar);

			ajax({
				method: 'GET',
				url: '/init',
				success: function(response) {
					var jsonResponse = JSON.parse(response);
					that.gopath = jsonResponse.gopath;
					that.projectPath = jsonResponse.projectPath;
					that.gocodePath = jsonResponse.gocodePath;
				}
			});
		}

		function loadCodePage(fileName) {
			ajax({
				method: 'POST',
				url: fileName,
				success: function(response) {
					editor.setValue(response);
					editor.clearSelection();
					editor.moveCursorToPosition({row: 0 , column: 0});
				}
			});
		}

		function loadSidebar(that) {
			ajax({
				method: 'GET',
				url: '/dir',
				success: function(response) {
					that.directory = JSON.parse(response);
				}
			});
		}

		Polymer({
			properties: {
				fileName: String,
				gopath: String,
				gocodePath: String,
				projectPath: String,
				language: String,
				autocompleteCandidates: Array,
				autocompleteEntry: String,
				directory: Object
			},

			ready: function() {
				//load sidebar
				loadSidebar(this);

				initEditor(this);

				this.fileName = document.location.pathname;
				if(this.fileName == '/') {
					return;
				}

				//load code page
				loadCodePage(this.fileName);

				//focus the editor
				editor.focus();
			},

			save: function() {
				var that = this;
				ajax({
					method: 'POST',
					url: '/save',
					data: {
						name: that.fileName,
						content: editor.getValue()
					},
					success: function(response) {
						that.$.fileSavedToast.show();
					},
					error: function() {
						alert('error saving file');
					}
				});
			},

			refreshCodePage: function() {
				loadCodePage(this.fileName);
			},

			refreshSidebar: function() {
				loadSidebar(this);
			},

			createNewFile: function() {
				this.$.fileNameInput.open();
			},

			setFileName: function() {
				history.pushState(null, null, this.fileName);
				initEditor();
			},

			toggleDrawer: function() {
				this.$.drawer.togglePanel();
			},

			resizeEditor: function(e) {
				if(this.$.drawer.selected == 'drawer') {
					this.$.content.style.marginLeft = this.$.drawer.drawerWidth;
				} else {
					this.$.content.style.marginLeft = '0';
				}
			},

			expandSidebar: function() {
				this.$.sidebar.open();
			},

			collapseSidebar: function() {
				this.$.sidebar.close();
			},

			openSettingsDialog: function() {
				this.$.settingsDialog.open();
			},

			saveSettings: function() {
				editor.getSession().setMode('ace/mode/' + this.language);
				loadSidebar(this);
				ajax({
					method: 'POST',
					url: '/saveSettings',
					data: {
						gopath: this.gopath,
						projectPath: this.projectPath,
						gocodePath: this.gocodePath
					},
					success: function() {},
					error: function(response) {
						alert('unable to save settings');
					}
				});
			}
		});	
	</script>

</dom-module>