<link rel="import" href="/static/bower_components/polymer/polymer.html">
<link rel="import" href="/static/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/static/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/static/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/static/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/static/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/static/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/static/bower_components/paper-input/paper-input.html">
<link rel="import" href="/static/bower_components/paper-button/paper-button.html">
<link rel="import" href="/static/bower_components/paper-toast/paper-toast.html">

<link rel="import" href="/static/bower_components/paper-styles/paper-styles.html">

<script src="/static/ace-builds/src-noconflict/ace.js"></script>
<script src="/static/ajax.js"></script>

<dom-module id="go-editor">

	<style is="custom-style">
		#content {
			font-size: 15px;
		}

		paper-button {
			background: #3f51b5;
			color: #fff;
		}

		#fileNameInput{
			width: 600px;
		}

		paper-toast {
			margin-left: 50px;
		}
	}
	</style>

	<template>
		<div id="container" fullbleed layout vertical>
			<paper-drawer-panel force-narrow id="drawer">

				<paper-header-panel drawer>
					<paper-toolbar></paper-toolbar>
    				<div class="fit">content fits 100% below the header</div>
				</paper-header-panel>

				<paper-header-panel main>
					<paper-toolbar>
						<paper-icon-button icon="menu" on-click="toggleDrawer"></paper-icon-button>
						<paper-icon-button icon="add" on-click="createNewFile"></paper-icon-button>
						<paper-icon-button icon="refresh"></paper-icon-button>
						<paper-icon-button icon="save" on-click="save"></paper-icon-button>
						<span/></span>
						<div class="title">Go Editor</div>
						<span>{{cursorRow}}</span>
						<span>:</span>
						<span>{{cursorColumn}}</span>
					</paper-toolbar>

					<div id="content" class="fit"></div>

					<paper-dialog id="fileNameInput">
						<div>
							<paper-input label="Enter file name:" autofocus value="{{fileName}}"></paper-input></br>
						</div>
						<div class="buttons">
							<paper-button dialog-confirm on-click="setFileName">Accept</paper-button>
						</div>
					</paper-dialog>

					<paper-toast id="fileSavedToast" text="File Saved Successfully"></paper-toast>
				</paper-header-panel>

			</paper-drawer-panel>
		</div>
	</template>

	<script>
		var editor;
		var initEditor;
		Polymer({
			properties: {
				fileName: String,
				cursorRow: Number,
				cursorColumn: Number
			},

			ready: function() {
				var that = this;

				initEditor = function() {
					//setup editor
					editor = ace.edit(that.$.content);
					editor.setTheme("ace/theme/chrome");
					editor.getSession().setMode("ace/mode/golang");
					editor.getSession().setTabSize(4);
					
					//track cursor position to be printed on toolbar
					editor.getSession().selection.on('changeCursor', function(e) {
						var pos = editor.getCursorPosition();
						that.cursorRow = pos.row;
						that.cursorColumn = pos.column;
					});

					//list autocompleton when . is typed
					editor.getSession().on('change', function(e) {
						if(e.action == 'insert' && e.lines[0] == '.') {
							console.log('.  typed');
							//console.log(editor.getSession().getDocument().positionToIndex(pos,  0));
						}
					});
				}

				this.fileName = document.location.pathname;
				if(this.fileName == '/') {
					return;
				} 

				initEditor();

				//load code page
				var xhr = new XMLHttpRequest();
    			xhr.onreadystatechange = function() {
        			if (xhr.readyState == XMLHttpRequest.DONE) {
           				if(xhr.status == 200){
               				editor.setValue(xhr.response); 
           				}
        			}
    			}
				xhr.open('POST', this.fileName);
				xhr.send();

				//focus the editor
				editor.focus();
			},

			save: function() {
				that = this;
				var xhr = new XMLHttpRequest();
    			xhr.onreadystatechange = function() {
        			if (xhr.readyState == XMLHttpRequest.DONE) {
           				if(xhr.status == 200){
               				that.$.fileSavedToast.show();
           				} else {
           					alert('error saving file');
           				}
        			}
    			}

    			var data = new FormData();
    			data.append('name', this.fileName);
				data.append('content', editor.getValue());

				xhr.open('POST', '/save');
				xhr.send(data);
			},

			createNewFile: function() {
				this.$.fileNameInput.open();
			},

			setFileName: function() {
				history.pushState(null, null, this.fileName);
				initEditor();
			},

			toggleDrawer: function() {
				this.$.drawer.togglePanel();
			}
		});	
	</script>

</dom-module>