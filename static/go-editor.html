<link rel="import" href="/static/bower_components/polymer/polymer.html">
<link rel="import" href="/static/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/static/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/static/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/static/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/static/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/static/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/static/bower_components/paper-input/paper-input.html">
<link rel="import" href="/static/bower_components/paper-button/paper-button.html">
<link rel="import" href="/static/bower_components/paper-toast/paper-toast.html">

<link rel="import" href="/static/tree-view.html">

<script src="/static/ace-builds/src-noconflict/ace.js"></script>
<script src="/static/ace-builds/src-noconflict/ext-language_tools.js"></script>

<script src="/static/ajax.js"></script>

<dom-module id="go-editor">

	<style is="custom-style">
		#content {
			font-size: 14px;
			transition-duration: 400ms;
			transition-timing-function: ease-out;
		}

		paper-button {
			background: #3f51b5;
			color: #fff;
		}

		#fileNameInput{
			width: 600px;
		}

		paper-toast {
			margin-left: 50px;
		}
	}
	</style>

	<template>
		<div id="container" fullbleed layout vertical>
			<paper-drawer-panel force-narrow id="drawer" on-iron-select="resizeEditor">

				<paper-header-panel id="drawer" drawer>
					<paper-toolbar>
						<paper-icon-button icon="refresh" on-click="refreshSidebar"></paper-icon-button>
						<paper-icon-button icon="expand-more" on-click="expandSidebar"></paper-icon-button>
						<paper-icon-button icon="expand-less" on-click="collapseSidebar"></paper-icon-button>
					</paper-toolbar>
    				<div class="fit">
    					<tree-view id="sidebar" data="[[directory]]"></tree-view>
    				</div>
				</paper-header-panel>

				<paper-header-panel main>
					<paper-toolbar>
						<paper-icon-button icon="menu" on-click="toggleDrawer"></paper-icon-button>
						<paper-icon-button icon="add" on-click="createNewFile"></paper-icon-button>
						<paper-icon-button icon="refresh" on-click="refreshCodePage"></paper-icon-button>
						<paper-icon-button icon="save" on-click="save"></paper-icon-button>
						<span/></span>
						<div class="title">Go Editor</div>
						<span>[[cursorRow]]</span>
						<span>:</span>
						<span>[[cursorColumn]]</span>
					</paper-toolbar>

					<div id="content" class="fit"></div>

					<paper-dialog id="fileNameInput">
						<div>
							<paper-input label="Enter file name:" autofocus value="{{fileName}}"></paper-input></br>
						</div>
						<div class="buttons">
							<paper-button dialog-confirm on-click="setFileName">OK</paper-button>
						</div>
					</paper-dialog>

					<paper-toast id="fileSavedToast" text="File Saved Successfully"></paper-toast>
				</paper-header-panel>

			</paper-drawer-panel>
		</div>
	</template>

	<script>
		var editor;

		function initEditor(that) {
			//setup editor
			var langTools = ace.require("ace/ext/language_tools");
			editor = ace.edit(that.$.content);
			editor.setTheme("ace/theme/chrome");
			editor.getSession().setMode("ace/mode/golang");
			editor.getSession().setTabSize(4);

			// enable autocompletion
			editor.setOptions({
				enableBasicAutocompletion: true,
				enableSnippets: false,
				enableLiveAutocompletion: false
			});
			
			var gocodeCompleter = {
				getCompletions: function(editor, session, pos, prefix, callback) {
					var offset = editor.getSession().getDocument().positionToIndex(pos,  0) + 1;

					ajax({
						method: 'POST',
						url: '/autocomplete',
						data: {
							offset: offset,
							content: editor.getValue()
						},
						success: function(response) {
							callback(null, JSON.parse(response).Candidates);
						},
						error: function() {
							alert('error in autocomplete');
						}
					});
				}
			}

			editor.completers = [gocodeCompleter]

			//track cursor position to be displayed on toolbar
			editor.getSession().selection.on('changeCursor', function(e) {
				var pos = editor.getCursorPosition();
				that.cursorRow = pos.row;
				that.cursorColumn = pos.column;
			});
		}

		function loadCodePage(fileName) {
			ajax({
				method: 'POST',
				url: fileName,
				success: function(response) {
					editor.setValue(response);
					editor.clearSelection();
					editor.moveCursorToPosition({row: 0 , column: 0});
				}
			});
		}

		function loadSidebar(that) {
			ajax({
				method: 'GET',
				url: '/dir',
				success: function(response) {
					that.directory = JSON.parse(response);
				}
			});
		}

		Polymer({
			properties: {
				fileName: String,
				cursorRow: Number,
				cursorColumn: Number,
				autocompleteCandidates: Array,
				directory: Object
			},

			ready: function() {
				var that = this;

				this.fileName = document.location.pathname;
				if(this.fileName == '/') {
					return;
				} 

				initEditor(this);

				//load code page
				loadCodePage(this.fileName);

				//load sidebar
				loadSidebar(this);

				//focus the editor
				editor.focus();
			},

			save: function() {
				var that = this;
				ajax({
					method: 'POST',
					url: '/save',
					data: {
						name: that.fileName,
						content: editor.getValue()
					},
					success: function(response) {
						that.$.fileSavedToast.show();
					},
					error: function() {
						alert('error saving file');
					}
				});
			},

			refreshCodePage: function() {
				loadCodePage(this.fileName);
			},

			refreshSidebar: function() {
				loadSidebar(this);
			},

			createNewFile: function() {
				this.$.fileNameInput.open();
			},

			setFileName: function() {
				history.pushState(null, null, this.fileName);
				initEditor();
			},

			toggleDrawer: function() {
				this.$.drawer.togglePanel();
			},

			resizeEditor: function(e) {
				if(this.$.drawer.selected == 'drawer') {
					this.$.content.style.marginLeft = this.$.drawer.drawerWidth;
				} else {
					this.$.content.style.marginLeft = '0';
				}
			},

			expandSidebar: function() {
				this.$.sidebar.open();
			},

			collapseSidebar: function() {
				this.$.sidebar.close();
			}
		});	
	</script>

</dom-module>